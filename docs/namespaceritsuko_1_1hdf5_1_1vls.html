<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ritsuko: ritsuko::hdf5::vls Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ritsuko
   </div>
   <div id="projectbrief">Helper utilities for ArtifactDB C++ code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespaceritsuko.html">ritsuko</a></li><li class="navelem"><a class="el" href="namespaceritsuko_1_1hdf5.html">hdf5</a></li><li class="navelem"><a class="el" href="namespaceritsuko_1_1hdf5_1_1vls.html">vls</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">ritsuko::hdf5::vls Namespace Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Assorted functions for handling <b>ritsuko</b>'s custom VLS arrays.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html">Pointer</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight"><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a> into the VLS heap.  <a href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classritsuko_1_1hdf5_1_1vls_1_1Stream1dArray.html">Stream1dArray</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stream a 1-dimensional VLS array into memory.  <a href="classritsuko_1_1hdf5_1_1vls_1_1Stream1dArray.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4b663e90f9c0729b1336650eb230a995" id="r_a4b663e90f9c0729b1336650eb230a995"><td class="memItemLeft" align="right" valign="top">H5::DataSet&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a4b663e90f9c0729b1336650eb230a995">open_pointers</a> (const H5::Group &amp;handle, const char *name, size_t offset_precision, size_t length_precision)</td></tr>
<tr class="separator:a4b663e90f9c0729b1336650eb230a995"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a21fa0f5458d346ab7f419b16f2edd4a3" id="r_a21fa0f5458d346ab7f419b16f2edd4a3"><td class="memItemLeft" align="right" valign="top">H5::DataSet&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a21fa0f5458d346ab7f419b16f2edd4a3">open_heap</a> (const H5::Group &amp;handle, const char *name)</td></tr>
<tr class="separator:a21fa0f5458d346ab7f419b16f2edd4a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8648c7288f1c09d0bb882edbca9ee19e" id="r_a8648c7288f1c09d0bb882edbca9ee19e"><td class="memTemplParams" colspan="2">template&lt;typename Offset_ , typename Length_ &gt; </td></tr>
<tr class="memitem:a8648c7288f1c09d0bb882edbca9ee19e"><td class="memTemplItemLeft" align="right" valign="top">H5::CompType&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="#a8648c7288f1c09d0bb882edbca9ee19e">define_pointer_datatype</a> ()</td></tr>
<tr class="separator:a8648c7288f1c09d0bb882edbca9ee19e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34c6f25b96bf830612b2ce5bbddb8ef0" id="r_a34c6f25b96bf830612b2ce5bbddb8ef0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a34c6f25b96bf830612b2ce5bbddb8ef0">validate_pointer_datatype</a> (const H5::CompType &amp;type, size_t offset_precision, size_t length_precision)</td></tr>
<tr class="separator:a34c6f25b96bf830612b2ce5bbddb8ef0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Assorted functions for handling <b>ritsuko</b>'s custom VLS arrays. </p>
<p>One weakness of HDF5 is its inability to efficiently handle variable length string (VLS) arrays. Storing them as fixed-length strings requires padding all strings to the longest string, causing an inflation in disk usage that cannot be completely negated by compression. On the other hand, HDF5's own VLS datatype does not compress the strings themselves, only the pointers to those strings.</p>
<p>To patch over this weakness in current versions of HDF5, <b>ritsuko</b> introduces its own concept of a VLS array. This is defined by two HDF5 datasets - one storing a VLS heap, and another storing pointers into that heap.</p>
<ul>
<li>The VLS heap is a 1-dimensional dataset of unsigned 8-bit integers, containing the concatenation of bytes from all variable length strings in the VLS array. Check out <code><a class="el" href="#a21fa0f5458d346ab7f419b16f2edd4a3">open_heap()</a></code> for details.</li>
<li>The pointer dataset is an N-dimensional dataset of a compound datatype defined by <code><a class="el" href="#a8648c7288f1c09d0bb882edbca9ee19e">define_pointer_datatype()</a></code>. Each entry of the pointer dataset contains the starting offset and length of a single VLS on the heap. Check out <code><a class="el" href="#a4b663e90f9c0729b1336650eb230a995">open_pointers()</a></code> for details.</li>
</ul>
<p>The idea is to read the pointer dataset into an array of <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code> instances, and then use the offset and length for each <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code> to extract a slice of characters from the heap. Each slice defines the VLS corresponding to that <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code>.</p>
<p>Typically the pointer and heap datasets for a single VLS array will be stored in their own group, where they can be opened by <code><a class="el" href="#a4b663e90f9c0729b1336650eb230a995">open_pointers()</a></code> and <code><a class="el" href="#a21fa0f5458d346ab7f419b16f2edd4a3">open_heap()</a></code>, respectively. See also <code><a class="el" href="classritsuko_1_1hdf5_1_1vls_1_1Stream1dArray.html" title="Stream a 1-dimensional VLS array into memory.">Stream1dArray</a></code> to quickly stream the contents of a VLS array. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a8648c7288f1c09d0bb882edbca9ee19e" name="a8648c7288f1c09d0bb882edbca9ee19e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8648c7288f1c09d0bb882edbca9ee19e">&#9670;&#160;</a></span>define_pointer_datatype()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename Offset_ , typename Length_ &gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">H5::CompType ritsuko::hdf5::vls::define_pointer_datatype </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Define a compound datatype for a realization of a <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code> type.</p>
<dl class="tparams"><dt>Template Parameters</dt><dd>
  <table class="tparams">
    <tr><td class="paramname">Offset_</td><td>Unsigned integer type for the starting offset, see <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#a44cba7041c3f3c71ec665cc09543777d">Pointer::offset</a></code>. </td></tr>
    <tr><td class="paramname">Length_</td><td>Unsigned integer type for the string length, see <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#a809f67cf82be6b7512531ea8822a77d8">Pointer::length</a></code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A HDF5 compound datatype. </dd></dl>

</div>
</div>
<a id="a21fa0f5458d346ab7f419b16f2edd4a3" name="a21fa0f5458d346ab7f419b16f2edd4a3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a21fa0f5458d346ab7f419b16f2edd4a3">&#9670;&#160;</a></span>open_heap()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">H5::DataSet ritsuko::hdf5::vls::open_heap </td>
          <td>(</td>
          <td class="paramtype">const H5::Group &amp;</td>          <td class="paramname"><span class="paramname"><em>handle</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>name</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Open a HDF5 dataset containing the VLS heap. This should be a 1-dimensional dataset of unsigned 8-bit integers, representing the concatenation of bytes from all the variable length strings in the VLS array. Ideally, all bytes are referenced by at least one <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code> in the associated pointer dataset, though this is not required, e.g., if a VLS is replaced with a shorter string.</p>
<p>We use an integer datatype rather than HDF5's own string datatypes to avoid the risk of a naive incorrect interpretation of the heap as an array of fixed-width strings.</p>
<p>When reading the heap into memory, users are advised to first load the bytes into an <code>unsigned char</code> array and then read them via an aliased <code>char *</code>. This preserves the bit patterns by avoiding a HDF5-mediated conversion between the dataset's unsigned 8-bit integer datatype and a possibly-signed <code>char</code> type. Conversely, when creating a heap dataset, we should use an aliased <code>unsigned char *</code> to access the contents C-style strings. We write this to the heap dataset by using HDF5 to trivially convert from the <code>NATIVE_UCHAR</code> memory type to the dataset's 8-bit unsigned integer datatype.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">handle</td><td>Group containing the dataset of pointers. </td></tr>
    <tr><td class="paramname">name</td><td>Name of the dataset of pointers.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>An open handle into a HDF5 dataset. </dd></dl>

</div>
</div>
<a id="a4b663e90f9c0729b1336650eb230a995" name="a4b663e90f9c0729b1336650eb230a995"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4b663e90f9c0729b1336650eb230a995">&#9670;&#160;</a></span>open_pointers()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">H5::DataSet ritsuko::hdf5::vls::open_pointers </td>
          <td>(</td>
          <td class="paramtype">const H5::Group &amp;</td>          <td class="paramname"><span class="paramname"><em>handle</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>name</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t</td>          <td class="paramname"><span class="paramname"><em>offset_precision</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t</td>          <td class="paramname"><span class="paramname"><em>length_precision</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Open a HDF5 dataset containing pointers into the VLS heap, used to define the individual strings in a VLS array.</p>
<p>There are no restrictions on the ordering of entries in the pointer dataset. Slices for consecutive <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code>s do not have to be ordered or contiguous. This allows one or more entries in the <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code> dataset to be modified without invalidating other entries. Different <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code>s can even refer to the same or even overlapping slices, which provides some opportunities to improve compression for repeated strings.</p>
<p>An error is raised if the dataset's datatype is not compound or does not meet the expectations defined by <code><a class="el" href="#a34c6f25b96bf830612b2ce5bbddb8ef0">validate_pointer_datatype()</a></code>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">handle</td><td>Group containing the dataset of pointers. </td></tr>
    <tr><td class="paramname">name</td><td>Name of the dataset of pointers. </td></tr>
    <tr><td class="paramname">offset_precision</td><td>Maximum number of bits in the integer type used for the start offset, see <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#a44cba7041c3f3c71ec665cc09543777d">Pointer::offset</a></code>. </td></tr>
    <tr><td class="paramname">length_precision</td><td>Maximum number of bits in the integer type used for the string length, see <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#a809f67cf82be6b7512531ea8822a77d8">Pointer::length</a></code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>An open handle into a HDF5 dataset. </dd></dl>

</div>
</div>
<a id="a34c6f25b96bf830612b2ce5bbddb8ef0" name="a34c6f25b96bf830612b2ce5bbddb8ef0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a34c6f25b96bf830612b2ce5bbddb8ef0">&#9670;&#160;</a></span>validate_pointer_datatype()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ritsuko::hdf5::vls::validate_pointer_datatype </td>
          <td>(</td>
          <td class="paramtype">const H5::CompType &amp;</td>          <td class="paramname"><span class="paramname"><em>type</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t</td>          <td class="paramname"><span class="paramname"><em>offset_precision</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t</td>          <td class="paramname"><span class="paramname"><em>length_precision</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Validate that a compound HDF5 datatype meets the expectations for storage in a <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code> instance, specifically:</p>
<ul>
<li>It has exactly two members.</li>
<li>The first member is named <code>offset</code> and is of an integer datatype that is unsigned and has no more than than <code>offset_precision</code> bits.</li>
<li>The second member is named <code>length</code> and is of an integer datatype that is unsigned and has no more than than <code>length_precision</code> bits.</li>
</ul>
<p>The constraints on the precision of each integer type ensure that the pointer dataset can be represented in memory by the associated type. For example, setting <code>offset_precision = 64</code> allows readers to safely assume that a <code>uint64_t</code> can be used for <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#a44cba7041c3f3c71ec665cc09543777d">Pointer::offset</a></code>.</p>
<p>On success, the contents of the HDF5 dataset associated with <code>type</code> can be safely read into an array of appropriately parameterized <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html" title="Pointer into the VLS heap.">Pointer</a></code> instances. Otherwise, an error is thrown.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">type</td><td>Compound datatype, typically generated from a <code>H5::DataSet</code> instance. </td></tr>
    <tr><td class="paramname">offset_precision</td><td>Maximum number of bits in the integer type used for the start position, see <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#a44cba7041c3f3c71ec665cc09543777d">Pointer::offset</a></code>. </td></tr>
    <tr><td class="paramname">length_precision</td><td>Maximum number of bits in the integer type used for the string size, see <code><a class="el" href="structritsuko_1_1hdf5_1_1vls_1_1Pointer.html#a809f67cf82be6b7512531ea8822a77d8">Pointer::length</a></code>. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
